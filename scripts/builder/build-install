#!/usr/bin/env build

echo "installing: ${1}"
eval $(build query --environ "${1}")

# FIXME this should be taken care of by the build config
if [ -z "${ARCHIVE_FORMAT}" ]; then
	ARCHIVE_FORMAT="tar.bz2"
fi

[ -f "${BUILDER_ATFDIR}/${NAME}-${VERSION}.${ARCHIVE_FORMAT}" ] || die "archive does not exist for package '${NAME}'"
if [ ! -d "${SYSROOT}" ]; then
	mkdir -p "${SYSROOT}" || die "failed to create system root @ '${SYSROOT}'"
fi

# FIXME the builder configs should decide the binpkg archive format.
case "${ARCHIVE_FORMAT}" in
(tbz2|tar.bz2)	ARCHIVE_DECOMPRESSOR="bzip2 -dc";;
(tgz|tar.gz)	ARCHIVE_DECOMPRESSOR="gzip -dc";;
(*)		die "unsupported archive format '${ARCHIVE_FORMAT}'";;
esac

cd "${SYSROOT}" && ${ARCHIVE_DECOMPRESSOR} "${BUILDER_ATFDIR}/${NAME}-${VERSION}.${ARCHIVE_FORMAT}" | tar x
cp -a "${W}/.compiled" "${W}/.installed"

# vim: filetype=sh
